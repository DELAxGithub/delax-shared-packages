name: Packages Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'packages/**'
      - 'tools/**'
      - 'templates/**'
      - 'package.json'
      - 'pnpm-lock.yaml'

jobs:
  quality-check:
    name: Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Install dependencies
        run: pnpm install
        
      - name: Type Check
        run: |
          echo "🔍 Running TypeScript checks..."
          pnpm run type-check
          
      - name: Lint
        run: |
          echo "🧹 Running linting..."
          pnpm run lint
          
      - name: Build
        run: |
          echo "🔨 Building packages..."
          pnpm run build
          
      - name: Package Structure Check
        run: |
          echo "📦 Checking package structure..."
          
          # Check for required files in each package
          for package_dir in packages/* tools/* templates/*; do
            if [ -d "$package_dir" ]; then
              echo "Checking $package_dir..."
              
              # Check for package.json
              if [ -f "$package_dir/package.json" ]; then
                echo "✅ $package_dir - package.json found"
              else
                echo "⚠️ $package_dir - Missing package.json"
              fi
              
              # Check for README
              if [ -f "$package_dir/README.md" ]; then
                echo "✅ $package_dir - README.md found"
              else
                echo "⚠️ $package_dir - Missing README.md"
              fi
            fi
          done
          
      - name: Workflow Scripts Validation
        run: |
          echo "🔧 Validating workflow scripts..."
          
          # Check if workflow-scripts package exists and has required scripts
          if [ -d "packages/workflow-scripts" ]; then
            echo "✅ workflow-scripts package found"
            
            # Check for key script files
            SCRIPTS_DIR="packages/workflow-scripts"
            for script in quick-pull.sh auto-pull.sh sync-pr.sh notify.sh; do
              if [ -f "$SCRIPTS_DIR/scripts/$script" ] || [ -f "$SCRIPTS_DIR/src/$script" ]; then
                echo "✅ $script found"
              else
                echo "⚠️ $script missing"
              fi
            done
          fi
          
      - name: Comment Result on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            
            const comment = `## ✅ Packages Quality Check Passed!

🎉 **すべてのパッケージ品質チェックが完了しました**

### チェック内容
- **TypeScript**: 型チェック完了
- **Lint**: コードスタイル確認完了
- **Build**: 全パッケージビルド成功
- **Package Structure**: パッケージ構造確認完了
- **Workflow Scripts**: 必須スクリプト確認完了

### 次のステップ
1. 変更内容をレビュー
2. 手動でマージを実行
3. パッケージの個別テストを実行
4. 必要に応じてバージョンアップ

**このPRは手動マージの準備ができています！** 🚀

---
🤖 *Technical Heritage Quality Assurance*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['✅ Quality Check Passed', 'Ready for review', 'Packages']
            });