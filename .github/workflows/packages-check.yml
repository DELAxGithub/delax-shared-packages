name: Packages Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'packages/**'
      - 'tools/**'
      - 'templates/**'
      - 'package.json'
      - 'pnpm-lock.yaml'

jobs:
  quality-check:
    name: Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Install dependencies
        run: pnpm install
        
      - name: Type Check
        run: |
          echo "ğŸ” Running TypeScript checks..."
          pnpm run type-check
          
      - name: Lint
        run: |
          echo "ğŸ§¹ Running linting..."
          pnpm run lint
          
      - name: Build
        run: |
          echo "ğŸ”¨ Building packages..."
          pnpm run build
          
      - name: Package Structure Check
        run: |
          echo "ğŸ“¦ Checking package structure..."
          
          # Check for required files in each package
          for package_dir in packages/* tools/* templates/*; do
            if [ -d "$package_dir" ]; then
              echo "Checking $package_dir..."
              
              # Check for package.json
              if [ -f "$package_dir/package.json" ]; then
                echo "âœ… $package_dir - package.json found"
              else
                echo "âš ï¸ $package_dir - Missing package.json"
              fi
              
              # Check for README
              if [ -f "$package_dir/README.md" ]; then
                echo "âœ… $package_dir - README.md found"
              else
                echo "âš ï¸ $package_dir - Missing README.md"
              fi
            fi
          done
          
      - name: Workflow Scripts Validation
        run: |
          echo "ğŸ”§ Validating workflow scripts..."
          
          # Check if workflow-scripts package exists and has required scripts
          if [ -d "packages/workflow-scripts" ]; then
            echo "âœ… workflow-scripts package found"
            
            # Check for key script files
            SCRIPTS_DIR="packages/workflow-scripts"
            for script in quick-pull.sh auto-pull.sh sync-pr.sh notify.sh; do
              if [ -f "$SCRIPTS_DIR/scripts/$script" ] || [ -f "$SCRIPTS_DIR/src/$script" ]; then
                echo "âœ… $script found"
              else
                echo "âš ï¸ $script missing"
              fi
            done
          fi
          
      - name: Comment Result on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            
            const comment = `## âœ… Packages Quality Check Passed!

ğŸ‰ **ã™ã¹ã¦ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å“è³ªãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ**

### ãƒã‚§ãƒƒã‚¯å†…å®¹
- **TypeScript**: å‹ãƒã‚§ãƒƒã‚¯å®Œäº†
- **Lint**: ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ç¢ºèªå®Œäº†
- **Build**: å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰æˆåŠŸ
- **Package Structure**: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ§‹é€ ç¢ºèªå®Œäº†
- **Workflow Scripts**: å¿…é ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆç¢ºèªå®Œäº†

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
1. å¤‰æ›´å†…å®¹ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼
2. æ‰‹å‹•ã§ãƒãƒ¼ã‚¸ã‚’å®Ÿè¡Œ
3. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å€‹åˆ¥ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
4. å¿…è¦ã«å¿œã˜ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—

**ã“ã®PRã¯æ‰‹å‹•ãƒãƒ¼ã‚¸ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã™ï¼** ğŸš€

---
ğŸ¤– *Technical Heritage Quality Assurance*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['âœ… Quality Check Passed', 'Ready for review', 'Packages']
            });